<div @fadeIn>
  <div class="content-card">
    <h2 class="content-card-title">Gesti√≥n de Usuarios</h2>

    <div class="filters-actions-container">
      <input type="text" (input)="onFilter($event)" placeholder="Buscar por nombre, rol o email..."
        class="filter-input">

      <button (click)="openModal('addRole')" class="btn-add-user">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
        </svg>
        Agregar Usuario
      </button>
    </div>

    <div class="data-table-container">
      @if (isLoading) {
      <div style="padding: 3rem; text-align: center; color: #78350f;">
        <p>Cargando usuarios...</p>
      </div>
      } @else {
      <table class="data-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Detalles</th>
            <th>Fecha Registro</th>
            <th class="actions-cell">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers; track user._id) {
          <tr>
            <td>
              <div style="font-weight: 700;">{{ user.firstName }} {{ user.lastName }}</div>
            </td>
            <td>
              @if (user.role === 'Educador') {
              <span class="badge badge-educator">Educador</span>
              } @else {
              <span class="badge badge-child">Ni√±o</span>
              }
            </td>

            <td>
              @if (user.role === 'Educador') {
              <div>{{ user.email }}</div>
              <small>{{ user.school || 'Sin escuela' }}</small>
              } @else {
              <div>{{ user.age }} a√±os</div>
              <small>Educador: {{ user.educatorId || 'No asignado' }}</small>
              }
            </td>

            <td>{{ user.createdAt | date:'dd MMM yyyy' }}</td>

            <td class="actions-cell">
              <button (click)="openModal('edit', user)" class="edit-btn icon-btn" title="Editar">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.862 4.487zm0 0L19.5 7.125">
                  </path>
                </svg>
              </button>
              <button (click)="openModal('delete', user)" class="delete-btn icon-btn" title="Eliminar">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.927a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165L5.677 19.673a2.25 2.25 0 002.244 2.077h7.128a2.25 2.25 0 002.244-2.077L19.58 5.79m-4.026 0c.182.025.364.05.546.075M9.26 5.79c.182.025.364.05.546.075">
                  </path>
                </svg>
              </button>
            </td>
          </tr>
          } @empty {
          <tr class="empty-row">
            <td colspan="5">No se encontraron usuarios que coincidan con la b√∫squeda.</td>
          </tr>
          }
        </tbody>
      </table>
      }
    </div>
  </div>
</div>

@if (isModalOpen) {
<div class="crud-modal-overlay" (click)="closeModal()">

  <div class="crud-modal-content" [class.modal-content-lg]="modalMode !== 'addRole' && modalMode !== 'delete'"
    (click)="$event.stopPropagation()">
    <button (click)="closeModal()" class="crud-modal-close-btn">&times;</button>

    <h3 class="crud-modal-title">
      @switch (modalMode) {
      @case ('addRole') { Seleccionar Tipo }
      @case ('addEducator') { Nuevo Educador }
      @case ('addChild') { Nuevo Ni√±o }
      @case ('editEducator') { Editar Educador }
      @case ('editChild') { Editar Ni√±o }
      @case ('delete') { Eliminar Usuario }
      }
    </h3>

    <div class="crud-modal-body">

      @if (modalMode === 'addRole') {
      <p>¬øQu√© tipo de usuario deseas agregar al sistema?</p>
      <div class="role-selection-actions">
        <button (click)="setModalMode('addEducator')" class="btn btn-primary">
          üë®‚Äçüè´ Educador
        </button>
        <button (click)="setModalMode('addChild')" class="btn btn-secondary">
          üë∂ Ni√±o
        </button>
      </div>
      }

      @if (modalMode === 'addEducator' || modalMode === 'editEducator' || modalMode === 'addChild' || modalMode ===
      'editChild') {
      <form class="form-grid" [formGroup]="userForm" (ngSubmit)="onUserSubmit()">

        @if (modalMode === 'addEducator' || modalMode === 'editEducator') {
        <div class="form-group">
          <label for="firstName">Nombre</label>
          <input type="text" id="firstName" formControlName="firstName" placeholder="Ej. Juan">
        </div>
        <div class="form-group">
          <label for="lastName">Apellido</label>
          <input type="text" id="lastName" formControlName="lastName" placeholder="Ej. P√©rez">
        </div>
        <div class="form-group form-group-full">
          <label for="email">Correo Electr√≥nico</label>
          <input type="email" id="email" formControlName="email" placeholder="juan@escuela.com">
        </div>
        <div class="form-group">
          <label for="school">Escuela / Instituci√≥n</label>
          <input type="text" id="school" formControlName="school" placeholder="Ej. Colegio San Jos√©">
        </div>
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" formControlName="password"
            [placeholder]="modalMode === 'editEducator' ? '(Dejar vac√≠o para mantener actual)' : 'M√≠nimo 6 caracteres'">
        </div>
        }

        @if (modalMode === 'addChild' || modalMode === 'editChild') {
        <div class="form-group">
          <label for="firstName">Nombre del Ni√±o</label>
          <input type="text" id="firstName" formControlName="firstName" placeholder="Ej. Pedrito">
        </div>
        <div class="form-group">
          <label for="lastName">Apellido</label>
          <input type="text" id="lastName" formControlName="lastName" placeholder="Ej. Gomez">
        </div>
        <div class="form-group">
          <label for="age">Edad</label>
          <input type="number" id="age" formControlName="age" placeholder="Ej. 8">
        </div>
        <div class="form-group">
          <label for="educatorId">Educador Responsable</label>
          <select id="educatorId" formControlName="educatorId"
            style="width: 100%; padding: 0.875rem 1rem; border-radius: 0.75rem; border: 2px solid transparent; background: #f3f4f6;">
            <option [value]="null" disabled>-- Selecciona un Educador --</option>
            @for (edu of allEducators; track edu._id) {
            <option [value]="edu._id">{{ edu.firstName }} {{ edu.lastName }}</option>
            }
          </select>
        </div>
        }

        <div class="form-actions">
          @if (formError) {
          <p class="error-message" style="margin-right: auto; margin-bottom: 0;">{{ formError }}</p>
          }
          <button type="button" (click)="closeModal()" class="btn btn-secondary"
            style="background: transparent; color: #78350f; border: 1px solid #fed7aa;">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
            {{ modalMode.includes('add') ? 'Crear Usuario' : 'Guardar Cambios' }}
          </button>
        </div>
      </form>
      }

      @if (modalMode === 'delete' && userToDelete) {
      <div style="text-align: center;">
        <p>
          ¬øEst√°s seguro de que deseas eliminar a <br>
          <strong style="font-size: 1.25rem; color: #ef4444;">{{ userToDelete.firstName }} {{ userToDelete.lastName
            }}</strong>?
        </p>
        <p style="font-size: 0.9rem; color: #78350f;">Esta acci√≥n no se puede deshacer.</p>

        @if (formError) {
        <p class="error-message">{{ formError }}</p>
        }

        <div class="form-actions" style="justify-content: center;">
          <button type="button" (click)="closeModal()" class="btn btn-secondary">Cancelar</button>
          <button type="button" (click)="onDeleteConfirm()" class="btn btn-danger">S√≠, Eliminar</button>
        </div>
      </div>
      }
    </div>
  </div>
</div>
}